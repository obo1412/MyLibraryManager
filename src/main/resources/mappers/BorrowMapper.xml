<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BorrowMapper">
	<resultMap id="borrow" type="com.gaimit.mlm.model.Borrow">
		<result property="idBrw" column="id_brw"/>
		<result property="idLibBrw" column="id_lib_brw"/>
		<result property= "bookHeldId" column="book_held_id"/>
		<result property="idMemberBrw" column="id_member_brw"/>
		<result property="startDateBrw" column="start_date_brw"/>
		<result property="endDateBrw" column="end_date_brw"/>
		
		<!-- member beans -->
		<result property="name" column="name"/>
		<result property="phone" column="phone"/>
		<result property="gradeId" column="grade_id"/>
		<result property="gradeName" column="grade_name"/>
		
		<!-- book beans -->
		<result property="titleBook" column="title_book"/>
		<result property="writerBook" column="writer_book"/>
		
		<!-- book_held beans -->
		<result property="localIdBarcode" column="local_id_barcode"/>
		<result property="copyCode" column="copy_code"/>
	</resultMap>
	
	<!-- 도서 대출 정보를 저장한다
		BrwBookOk.java - brwList 사용 -->
	<insert id="insertBrw" parameterType="com.gaimit.mlm.model.Borrow" useGeneratedKeys="true" keyProperty="id_brw">
		INSERT INTO borrow (
			id_lib_brw, book_held_id, id_member_brw, start_date_brw
		) VALUES (
			#{idLibBrw}, #{bookHeldId}, #{idMemberBrw}, now()
		)
	</insert>
	
	<!-- getBorrowList -->
	<select id="selectBorrowList" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			id_brw, id_lib_brw, book_held_id, b.title_book,
			id_member_brw, m.name, m.phone, start_date_brw, end_date_brw
		FROM borrow r
		INNER JOIN book_held h ON r.book_held_id = h.id
		INNER JOIN book b ON b.id_book = h.book_id_book
		INNER JOIN member m ON r.id_member_brw = m.id
		WHERE id_lib_brw = #{idLibBrw} AND end_date_brw is NULL
		ORDER BY start_date_brw ASC
	</select>
	
	<!-- brwBook.java - 오늘의 대출/반납 표시 -->
	<select id="selectBorrowListToday" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			id_brw, id_lib_brw, book_held_id, b.title_book, local_id_barcode,
			id_member_brw, m.name, m.phone, start_date_brw, end_date_brw, grade_name
		FROM borrow r
		INNER JOIN book_held h ON r.book_held_id = h.id
		INNER JOIN book b ON b.id_book = h.book_id_book
		INNER JOIN member m ON r.id_member_brw = m.id
		INNER JOIN member_grade g ON m.grade_id = g.grade_id
		WHERE id_lib_brw = #{idLibBrw} AND start_date_brw > curdate() OR end_date_brw > curdate()
		ORDER BY id_brw ASC
	</select>
	
	<!-- getBorrowItemByBarcodeBook
		ReturnBookOk - idBrw 호출을 위해 사용 -->
	<select id="selectBorrowItemByBarcodeBook" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			id_brw, id_lib_brw, book_held_id, local_id_barcode,
			id_member_brw, m.name as name, m.phone, start_date_brw, end_date_brw
		FROM borrow r
		INNER JOIN book_held h on r.book_held_id = h.id
		INNER JOIN member m on r.id_member_brw = m.id
		WHERE id_lib_brw=#{idLibBrw} AND end_date_brw is NULL AND local_id_barcode=#{localIdBarcode}
		ORDER BY start_date_brw ASC
	</select>
	
	<select id="selectBorrowListByMbrId" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			id_brw, id_lib_brw, id_book_brw, b.id_code_book as id_code_book, b.name_book as name_book,
			id_member_brw, m.name as name, m.phone, start_date_brw, end_date_brw
		FROM borrow r
		INNER JOIN book b on r.book_held_id = b.id_book
		INNER JOIN member m on r.id_member_brw = m.id
		WHERE id_member_brw=#{idMemberBrw} AND end_date_brw is NULL
		ORDER BY start_date_brw ASC
	</select>
	
	<!-- ReturnBookOk.java - 책반납 업데이트 -->
	<update id="updateBorrowEndDate" parameterType="com.gaimit.mlm.model.Borrow">
		UPDATE borrow r
		INNER JOIN book_held h on r.book_held_id = h.id
		SET end_date_brw=now()
		WHERE id_lib_brw=#{idLibBrw} AND local_id_barcode=#{localIdBarcode} AND id_brw=#{idBrw}
	</update>
	
	<select id="selectBorrowRtnd" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			id_brw, id_lib_brw, id_book_brw, b.id_code_book as id_code_book, b.name_book as name_book,
			id_member_brw, m.name as name, m.phone, start_date_brw, end_date_brw
		FROM borrow r
		INNER JOIN book b on r.id_book_brw = b.id_book
		INNER JOIN member m on r.id_member_brw = m.id
		WHERE id_lib_brw=#{idLibBrw} AND id_code_book=#{idCodeBook} AND id_brw=#{idBrw}
		ORDER BY start_date_brw ASC
	</select>
	
	<select id="selectBorrowCountByBarcodeBook" parameterType="com.gaimit.mlm.model.Borrow" resultType="int">
		SELECT count(id_brw)
		FROM borrow b
		INNER JOIN book_held h ON b.book_held_id = h.id
		WHERE id_lib_brw=#{idLibBrw}
			AND end_date_brw is NULL
			AND local_id_barcode = #{localIdBarcode}
	</select>
	
	<!-- bookHeldListPopup 에도 대출중이 아닌 책 검색 할때 사용
		도서리스트중에도 도서관 내의 책 검색에도 사용될 예정 -->
		<!-- 괄호도 신경써야된다.....!!!!! -->
	<select id="selectRemainedBookOnLibrary" parameterType="com.gaimit.mlm.model.Borrow" resultMap="borrow">
		SELECT
			title_book, writer_book, local_id_barcode, copy_code
		FROM book_held h
		LEFT OUTER JOIN borrow r ON h.id = r.book_held_id
		INNER JOIN book b on b.id_book = h.book_id_book
		WHERE (library_id_lib = #{libraryIdLib}
		AND (book_held_id NOT IN (SELECT book_held_id FROM borrow r WHERE end_date_brw IS NULL))
		OR (library_id_lib = #{libraryIdLib} AND id_brw IS NULL))
		<if test="titleBook != null">
			AND title_book LIKE concat('%', #{titleBook}, '%')
		</if>
		GROUP BY id
	</select>
	
</mapper>